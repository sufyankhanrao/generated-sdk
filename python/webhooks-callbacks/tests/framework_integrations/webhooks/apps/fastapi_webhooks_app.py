"""
 webhooksandcallbacksapi

 This file was automatically generated by APIMATIC v3.0 ( https://www.apimatic.io ).
"""
# ruff: noqa: RET505

from fastapi import (
    FastAPI,
    Request,
)
from fastapi.responses import JSONResponse

from webhooksandcallbacksapi.events.signature_verification_failure import (
    SignatureVerificationFailure,
)
from webhooksandcallbacksapi.events.unknown_event import (
    UnknownEvent,
)
from webhooksandcallbacksapi.events.webhooks.webhooks_handler import (
    WebhooksHandler,
)
from webhooksandcallbacksapi.models.order_updated_event import (
    OrderUpdatedEvent,
)
from webhooksandcallbacksapi.utilities.request_adapter import (
    to_core_request_async,
)

app = FastAPI()

@app.post("/webhooks")
async def webhooks(request: Request) -> JSONResponse:
    """
     Process incoming `webhooks` requests.

    :param request: The incoming HTTP request.

    :return: A JSON response indicating the handling result.
    """
    # Step 1: Create the handler with your shared secret key.
    handler = WebhooksHandler(secret_key="your-shared-secret")

    # Step 2: Convert the incoming request using to_core_request (Django/Flask)
    #         or await to_core_request_async (FastAPI).
    core_req = await to_core_request_async(request)

    # Step 3: Verify and parse the request into a typed event.
    event = handler.verify_and_parse_event(core_req)

    # Step 4: Pattern match for orderUpdated only.
    if isinstance(event, OrderUpdatedEvent):
        return JSONResponse(status_code=200, content={})
    elif isinstance(event, SignatureVerificationFailure):
        print("Signature verification failed")
        # TODO: add signature verification failure handling
    elif isinstance(event, UnknownEvent):
        print("Unknown event")
        # TODO: add unknown event handling

    return JSONResponse(status_code=400, content={})
