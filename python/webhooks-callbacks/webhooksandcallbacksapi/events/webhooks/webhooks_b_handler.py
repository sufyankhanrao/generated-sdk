"""
 webhooksandcallbacksapi

 This file was automatically generated by APIMATIC v3.0 ( https://www.apimatic.io ).
"""
from __future__ import annotations

import hashlib
from typing import (
    Optional,
    Union,
)

from apimatic_core.security.signature_verifiers.hmac_signature_verifier import (
    Base64Encoder,
    HmacSignatureVerifier,
)

from webhooksandcallbacksapi.api_helper import (
    APIHelper,
)
from webhooksandcallbacksapi.events.signature_verification_failure import (
    SignatureVerificationFailure,
)
from webhooksandcallbacksapi.events.signature_verification_result import (
    SignatureVerificationResult,
)
from webhooksandcallbacksapi.events.unknown_event import (
    UnknownEvent,
)
from webhooksandcallbacksapi.http.request import (
    Request,
)
from webhooksandcallbacksapi.models.inventory_stock_decrease_event import (
    InventoryStockDecreaseEvent,
)
from webhooksandcallbacksapi.models.inventory_stock_depleted_event import (
    InventoryStockDepletedEvent,
)
from webhooksandcallbacksapi.models.inventory_stock_increase_event import (
    InventoryStockIncreaseEvent,
)
from webhooksandcallbacksapi.models.system_alert_notification_event import (
    SystemAlertNotificationEvent,
)
from webhooksandcallbacksapi.models.system_maintenance_notification_event import (
    SystemMaintenanceNotificationEvent,
)
from webhooksandcallbacksapi.models.system_performance_notification_event import (
    SystemPerformanceNotificationEvent,
)
from webhooksandcallbacksapi.models.user_action_notification_event import (
    UserActionNotificationEvent,
)
from webhooksandcallbacksapi.models.user_preference_notification_event import (
    UserPreferenceNotificationEvent,
)
from webhooksandcallbacksapi.models.user_status_notification_event import (
    UserStatusNotificationEvent,
)
from webhooksandcallbacksapi.utilities.union_type_lookup import (
    UnionTypeLookUp,
)

WebhooksBEventType = Union[
    UserActionNotificationEvent,
    UserStatusNotificationEvent,
    UserPreferenceNotificationEvent,
    SystemAlertNotificationEvent,
    SystemMaintenanceNotificationEvent,
    SystemPerformanceNotificationEvent,
    InventoryStockIncreaseEvent,
    InventoryStockDecreaseEvent,
    InventoryStockDepletedEvent,
    SignatureVerificationFailure,
    UnknownEvent,
]

class WebhooksBHandler:
    """
     Multi-event webhook group with oneOf payload structures. Uses a message template
    that also includes a request header pointer.
    """

    def __init__(self, secret_key: str) -> None:
        """
         Initialize the handler.

        :param secret_key: The secret used to generate and validate HMAC signatures for
                           verifying request authenticity.
        :type secret_key: str
        """
        if not secret_key:
            raise ValueError("secret_key must be provided for signature verification.")
        self._verifier = HmacSignatureVerifier(
            secret_key=secret_key,
            signature_header="X-Webhook-Signature",
            hash_alg=hashlib.sha512,
            encoder=Base64Encoder(),
            signature_value_template="v1={digest}",
            canonical_message_builder=self._canonical_message_builder,
        )

    def verify(self, request: Request) -> SignatureVerificationResult:
        """
         Perform signature verification and return the result.

        :param request: The incoming HTTP request to verify.
        :type request: Request

        :return: The result of the signature verification.
        :rtype: SignatureVerificationResult
        """
        return self._verifier.verify(request)

    def verify_and_parse_event(self, request: Request) -> WebhooksBEventType:
        """
         Verify the request signature and parse the event.

        :return: UserActionNotificationEvent, UserStatusNotificationEvent,
                 UserPreferenceNotificationEvent, SystemAlertNotificationEvent,
                 SystemMaintenanceNotificationEvent, SystemPerformanceNotificationEvent,
                 InventoryStockIncreaseEvent, InventoryStockDecreaseEvent,
                 InventoryStockDepletedEvent for successful parsing;
                 SignatureVerificationFailure when signature fails; UnknownEvent for
                 unknown events.
        :rtype: Union[UserActionNotificationEvent, UserStatusNotificationEvent,
                UserPreferenceNotificationEvent, SystemAlertNotificationEvent,
                SystemMaintenanceNotificationEvent, SystemPerformanceNotificationEvent,
                InventoryStockIncreaseEvent, InventoryStockDecreaseEvent,
                InventoryStockDepletedEvent, SignatureVerificationFailure, UnknownEvent]
        """
        if (
            request is None or
            not hasattr(request, "headers") or
            not hasattr(request, "raw_body")
        ):
            return SignatureVerificationFailure([
                "Invalid request object.",
            ])
        if request.headers is None or not hasattr(request.headers, "items"):
            return SignatureVerificationFailure([
                "Invalid headers.",
            ])
        verification_result = self.verify(request)
        if not verification_result.ok:
            return SignatureVerificationFailure(verification_result.errors)
        # Deserialize payload
        try:
            union = UnionTypeLookUp.get("webhooksB")
            return APIHelper.deserialize_union_type(union, request.raw_body)
        except Exception as e:
            return UnknownEvent([
                "Deserialization failed.",
                str(e),
            ])

    @staticmethod
    def _canonical_message_builder(request: Request) -> Optional[bytes]:
        """
         Build the canonical message from the request for the signature verification.

        :param request: The incoming HTTP request.
        :type request: Request

        :return: The canonical message as bytes, or None if the message could not be
                 constructed.
        :rtype: Optional[bytes]
        """
        payload = request.raw_body.decode()
        method = request.method
        x_timestamp = request.headers.get("X-Timestamp", None)
        return f"{method}|{x_timestamp}|{payload}".encode()
