
"""
dropbox

This file was automatically generated by APIMATIC v3.0 (
 https://www.apimatic.io ).
"""

import os

from apimatic_core.authentication.header_auth import (
    HeaderAuth,
)
from apimatic_core.utilities.auth_helper import (
    AuthHelper,
)

from dropbox.api_helper import APIHelper
from dropbox.configuration import Server
from dropbox.models.o_auth_token import OAuthToken


class OAuth2(HeaderAuth):
    """
    An authentication handler that applies `ImplicitAuth` to
    outgoing requests. It constructs the required credential values and integrates
    with the core authentication framework.
    """

    @property
    def error_message(self):
        """Return reason about the authentication failure."""
        return "ImplicitAuth: OAuthToken is undefined or expired."

    def __init__(self, auth_credentials_model, config):
        """
        Initialize the authentication handler with credential data.

        Args:
            auth_credentials_model: The credentials object used to generate
                the authorization header.
            config: The configuration instance.

        """
        self._o_auth_client_id = auth_credentials_model.o_auth_client_id \
            if auth_credentials_model is not None else None
        self._o_auth_redirect_uri = auth_credentials_model.o_auth_redirect_uri \
            if auth_credentials_model is not None else None
        if auth_credentials_model is not None \
                and isinstance(auth_credentials_model.o_auth_token, OAuthToken):
            self._o_auth_token = OAuthToken.from_dictionary(
                APIHelper.to_dictionary(auth_credentials_model.o_auth_token))
        else:
            self._o_auth_token = auth_credentials_model.o_auth_token \
                if auth_credentials_model is not None else None
        if auth_credentials_model is not None \
                and isinstance(auth_credentials_model.o_auth_scopes, list):
            self._o_auth_scopes = auth_credentials_model.o_auth_scopes
        else:
            self._o_auth_scopes = None
        self._config = config
        auth_params = {}
        if (self._o_auth_token
                and hasattr(self._o_auth_token, "access_token")):
            auth_params = {"Authorization": f"Bearer {self._o_auth_token.access_token}"}
        super().__init__(auth_params=auth_params)

    def is_valid(self):
        """
        Validate credentials for authentication.

        Returns:
            bool: True if the credentials are valid, False otherwise.

        """
        return (self._o_auth_token and isinstance(self._o_auth_token, OAuthToken)
                and not self.is_token_expired(self._o_auth_token))

    def get_authorization_url(self, state=None, additional_params=None):
        """
        Build and return an authorization URL. The user is expected to
        obtain an authorization code from this URL and then call the authorize
        function with that authorization code.

        Args:
            state (str): An opaque state string.
            additional_params (dict): Any additional query parameters
                to be added to the URL.

        Returns:
            str: The authorization URL.

        """
        auth_url = self._config.get_base_uri(Server.AUTH)
        auth_url += "/authorize"
        query_params = {
            "response_type": "code",
            "client_id": self._o_auth_client_id,
            "redirect_uri": self._o_auth_redirect_uri,
        }
        if self._o_auth_scopes:
            query_params["scope"] = " ".join(self._o_auth_scopes)
        if state:
            query_params["state"] = state
        if additional_params:
            query_params.update(additional_params)
        auth_url = APIHelper.append_url_with_query_parameters(auth_url, query_params)
        return APIHelper.clean_url(auth_url)

    def is_token_expired(self, o_auth_token=None):
        """
        Check if OAuth token has expired.

        Args:
            o_auth_token (OAuthToken): The OAuth token whose expiry is to be checked.

        Returns:
            bool: True if OAuth token has expired, False otherwise.

        """
        if o_auth_token is None:
            return (hasattr(self._o_auth_token, "expiry")
                    and AuthHelper.is_token_expired(
                        self._o_auth_token.expiry))

        return (hasattr(o_auth_token, "expiry")
                and AuthHelper.is_token_expired(
                    o_auth_token.expiry))


class ImplicitAuthCredentials:
    """
    A model for authentication credentials. Provides simple validation,
    cloning support, and optional construction from environment variables.
    Suitable as a pattern for other auth models.
    """

    @property
    def o_auth_client_id(self):
        """
        OAuth 2 Client ID.
        """
        return self._o_auth_client_id

    @property
    def o_auth_redirect_uri(self):
        """
        OAuth 2 Redirection endpoint or Callback Uri.
        """
        return self._o_auth_redirect_uri

    @property
    def o_auth_token(self):
        """
        Object for storing information about the OAuth token.
        """
        return self._o_auth_token

    @property
    def o_auth_scopes(self):
        """
        List of scopes that apply to the OAuth token.
        """
        return self._o_auth_scopes

    def __init__(self, o_auth_client_id, o_auth_redirect_uri, o_auth_token=None,
                 o_auth_scopes=None):
        """
        Initialize the credentials.

        Args:
            o_auth_client_id: The o_auth_client_id property value to set.
            o_auth_redirect_uri: The o_auth_redirect_uri property value to set.
            o_auth_token: The o_auth_token property value to set.
            o_auth_scopes: The o_auth_scopes property value to set.

        Raises:
            ValueError: If any required value is missing.

        """
        if o_auth_client_id is None:
            raise ValueError("o_auth_client_id cannot be None")
        if o_auth_redirect_uri is None:
            raise ValueError("o_auth_redirect_uri cannot be None")
        self._o_auth_client_id = o_auth_client_id
        self._o_auth_redirect_uri = o_auth_redirect_uri
        self._o_auth_token = o_auth_token
        self._o_auth_scopes = o_auth_scopes

    def clone_with(self, o_auth_client_id=None, o_auth_redirect_uri=None,
                   o_auth_token=None, o_auth_scopes=None):
        """
        Return a new instance with optional value overrides.

        Args:
            o_auth_client_id: The o_auth_client_id property value to set.
            o_auth_redirect_uri: The o_auth_redirect_uri property value to set.
            o_auth_token: The o_auth_token property value to set.
            o_auth_scopes: The o_auth_scopes property value to set.

        """
        return ImplicitAuthCredentials(
            o_auth_client_id or self.o_auth_client_id,
            o_auth_redirect_uri or self.o_auth_redirect_uri,
            o_auth_token or self.o_auth_token,
            o_auth_scopes or self.o_auth_scopes)

    @classmethod
    def from_environment(cls):
        """
        Create credentials from environment variables, if available.

        Returns:
            A credentials instance or ``None`` if values are missing.

        """
        o_auth_client_id = os.getenv(
            "O_AUTH_CLIENT_ID",
            None,
        )
        o_auth_redirect_uri = os.getenv(
            "O_AUTH_REDIRECT_URI",
            None,
        )
        o_auth_scopes = os.getenv(
            "O_AUTH_SCOPES",
            None,
        )

        if (o_auth_client_id is None
                or o_auth_redirect_uri is None):
            return None

        o_auth_scopes = [
            v.strip() for v in o_auth_scopes.split(",") if v.strip()
        ] if o_auth_scopes else None

        return cls(
            o_auth_client_id=o_auth_client_id,
            o_auth_redirect_uri=o_auth_redirect_uri,
            o_auth_scopes=o_auth_scopes,
        )
