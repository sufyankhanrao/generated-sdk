# -*- coding: utf-8 -*-

"""
mdnotesropo

This file was automatically generated by APIMATIC v3.0 (
 https://www.apimatic.io ).
"""

import os
from apimatic_core.authentication.header_auth import HeaderAuth
from mdnotesropo.api_helper import APIHelper
from mdnotesropo.models.o_auth_token import OAuthToken
from apimatic_core.utilities.auth_helper import AuthHelper
from mdnotesropo.controllers.o_auth_authorization_controller import\
    OAuthAuthorizationController


class OAuth2(HeaderAuth):

    @property
    def error_message(self):
        """Display error message on occurrence of authentication failure
        in ResourcePasswordAuth

        """
        return "ResourcePasswordAuth: OAuthToken is undefined or expired."

    def __init__(self, resource_password_auth_credentials, config):
        self._o_auth_username = resource_password_auth_credentials.o_auth_username \
            if resource_password_auth_credentials is not None else None
        self._o_auth_password = resource_password_auth_credentials.o_auth_password \
            if resource_password_auth_credentials is not None else None
        if resource_password_auth_credentials is not None \
                and isinstance(resource_password_auth_credentials.o_auth_token, OAuthToken):
            self._o_auth_token = OAuthToken.from_dictionary(
                APIHelper.to_dictionary(resource_password_auth_credentials.o_auth_token))
        else:
            self._o_auth_token = resource_password_auth_credentials.o_auth_token \
                if resource_password_auth_credentials is not None else None
        if resource_password_auth_credentials is not None \
                and isinstance(resource_password_auth_credentials.o_auth_scopes, list):
            self._o_auth_scopes = resource_password_auth_credentials.o_auth_scopes
        else:
            self._o_auth_scopes = None
        self._o_auth_api = OAuthAuthorizationController(config)
        auth_params = {}
        if isinstance(self._o_auth_token, OAuthToken) and hasattr(self._o_auth_token, 'access_token'):
            auth_params = {"Authorization": "Bearer {}".format(self._o_auth_token.access_token)}
        super().__init__(auth_params=auth_params)

    def is_valid(self):
        return (self._o_auth_token and isinstance(self._o_auth_token, OAuthToken)
                and not self.is_token_expired(self._o_auth_token))

    def fetch_token(self, additional_params=None):
        """ Authorizes the client.

            
            additional_params (dict):  Any additional form parameters.

        Returns:
            OAuthToken: The OAuth token.

        """
        token = self._o_auth_api.request_token(
            self._o_auth_username,
            self._o_auth_password,
            ' '.join(self._o_auth_scopes) if self._o_auth_scopes else None,
            _optional_form_parameters=additional_params
        ).body
        if hasattr(token, 'expires_in'):
            current_utc_timestamp = AuthHelper.get_current_utc_timestamp()
            token.expiry = AuthHelper.get_token_expiry(current_utc_timestamp, token.expires_in)
        return token

    def is_token_expired(self, o_auth_token=None):
        """ Checks if OAuth token has expired.

        Args:
            o_auth_token (OAuthToken): The OAuth token whose expiry is to be checked.

        Returns:
            bool: True if OAuth token has expired, False otherwise.

        """
        if o_auth_token is None:
            return (hasattr(self._o_auth_token, 'expiry')
                    and AuthHelper.is_token_expired(self._o_auth_token.expiry))

        return (hasattr(o_auth_token, 'expiry')
                and AuthHelper.is_token_expired(o_auth_token.expiry))

    def refresh_token(self, additional_params=None):
        """ Refreshes OAuth token.

        Args:
            additional_params (dict):  Any additional form parameters.

        Returns:
            OAuthToken: The refreshed OAuth token.

        """
        token = self._o_auth_api.refresh_token(
            self._o_auth_token.refresh_token,
            ' '.join(self._o_auth_scopes) if self._o_auth_scopes else None,
            _optional_form_parameters=additional_params
        ).body
        if hasattr(token, 'expires_in'):
            current_utc_timestamp = AuthHelper.get_current_utc_timestamp()
            token.expiry = AuthHelper.get_token_expiry(current_utc_timestamp, token.expires_in)
        return token


class ResourcePasswordAuthCredentials:

    @property
    def o_auth_username(self):
        return self._o_auth_username

    @property
    def o_auth_password(self):
        return self._o_auth_password

    @property
    def o_auth_token(self):
        return self._o_auth_token

    @property
    def o_auth_scopes(self):
        return self._o_auth_scopes

    def __init__(self, o_auth_username, o_auth_password, o_auth_token=None,
                 o_auth_scopes=None):
        if o_auth_username is None:
            raise ValueError('o_auth_username cannot be None')
        if o_auth_password is None:
            raise ValueError('o_auth_password cannot be None')
        self._o_auth_username = o_auth_username
        self._o_auth_password = o_auth_password
        self._o_auth_token = o_auth_token
        self._o_auth_scopes = o_auth_scopes

    def clone_with(self, o_auth_username=None, o_auth_password=None,
                   o_auth_token=None, o_auth_scopes=None):
        return ResourcePasswordAuthCredentials(
            o_auth_username or self.o_auth_username,
            o_auth_password or self.o_auth_password,
            o_auth_token or self.o_auth_token,
            o_auth_scopes or self.o_auth_scopes)

    @classmethod
    def from_environment(cls):
        o_auth_username = os.getenv('O_AUTH_USERNAME', None)
        o_auth_password = os.getenv('O_AUTH_PASSWORD', None)
        o_auth_scopes = os.getenv('O_AUTH_SCOPES', None)

        if o_auth_username is None or o_auth_password is None:
            return None

        o_auth_scopes = [
            v.strip() for v in o_auth_scopes.split(",") if v.strip()
        ] if o_auth_scopes else None

        return cls(
            o_auth_username=o_auth_username,
            o_auth_password=o_auth_password,
            o_auth_scopes=o_auth_scopes
        )